# ⚠️⚠️⚠️ CRITICAL - READ THIS FIRST BEFORE ANY ACTION ⚠️⚠️⚠️

## 🔴 规则0: 强制使用MCP工具 (优先级: CRITICAL)

**在调用任何工具之前，你必须先执行以下检查：**

```
STEP 1: 检查工具名称
- 我即将使用的工具是什么？
- 它是否在以下列表中？
  [write, read_file, search_replace, run_terminal_cmd, grep, delete_file, list_dir, glob_file_search]

STEP 2: 如果在上述列表中
- ❌ 停止！不要使用这个工具
- ✅ 改用对应的 mcp_ 前缀版本：
  write → mcp_write
  read_file → mcp_read_file
  search_replace → mcp_search_replace
  run_terminal_cmd → mcp_run_terminal_cmd
  grep → mcp_grep
  delete_file → mcp_delete_file
  list_dir → mcp_list_dir
  glob_file_search → mcp_glob_file_search

STEP 3: 确认
- 我现在使用的是 mcp_ 前缀的工具吗？
- 如果是 → 继续
- 如果不是 → 返回STEP 1
```

### 🚫 使用原生工具的后果

- 统计信息不显示 (0/535条)
- 规则不触发
- 拦截器不工作
- 用户会抱怨 "又没看到统计"

### ✅ 正确行为示例

```
错误: read_file("file.txt")
正确: mcp_read_file("file.txt")

错误: write("file.txt", content)
正确: mcp_write("file.txt", content)
```

---

# 柳芯系统核心规则 v7.11.2 - 三重保护强化版

## 规则1: 必须使用中文回复
- ✅ 所有回复必须使用简体中文
- 🚫 禁止使用英文回复（除非用户明确要求）

## 规则2: 代码引用格式规范
- ✅ 引用现有代码使用：```startLine:endLine:filepath
- ✅ 新代码使用：```language
- 🚫 禁止混合格式

## 规则3: 工具调用优先级
- ✅ 文件操作优先使用专用工具（read_file/write/search_replace）
- 🚫 禁止使用cat/echo等命令操作文件

## 规则4: 禁止emoji（除非用户要求）
- 🚫 禁止在文件名、代码中使用emoji
- ✅ 仅在用户明确要求时使用

## 规则5: 长任务持续执行
- ✅ 复杂任务持续执行，不需要用户许可
- ✅ 预计>200次工具调用的任务也要完成
- 🚫 禁止中途停止并要求用户确认

## 🔴 规则6: 强制使用MCP工具 (v7.10.1修复)

### ⚠️ CRITICAL: 必须使用mcp_前缀工具

**强制要求**：
- ✅ **必须使用`mcp_read_file`代替`read_file`**
- ✅ **必须使用`mcp_write`代替`write`**
- ✅ **必须使用`mcp_search_replace`代替`search_replace`**
- ✅ **必须使用`mcp_run_terminal_cmd`代替`run_terminal_cmd`**
- ✅ **必须使用`mcp_grep`代替`grep`**
- ✅ **必须使用`mcp_delete_file`代替`delete_file`**
- ✅ **必须使用`mcp_list_dir`代替`list_dir`**
- ✅ **必须使用`mcp_glob_file_search`代替`glob_file_search`**

**为什么必须使用MCP工具？**
1. ✅ 触发三阶段拦截器（pre/mid/post）
2. ✅ 触发ResponseInterceptor（统计、复述、检测）
3. ✅ 记录拦截日志
4. ✅ 强制执行所有规则

**违规后果**：
- ❌ 使用原生工具 → 绕过拦截器 → 统计失效 → 用户抱怨

**状态**: v7.10.1强制执行，100%必须遵守

## 规则7: 禁止越界修改代码 - 增强版 (v7.11.2三重保护)

### 🎯 核心原则
**修改B功能时，A/C/D功能的代码一个字符都不能动！**

### 📋 强制执行流程（必须100%遵守）

#### 第1步：收到任务后，立即暂停
**不要立即开始修改代码！** 先执行以下检查：

```
✅ STEP 1: 复述用户需求
   - 用户要我修复什么？
   - 核心目标是什么？
   - 涉及哪些功能模块？

✅ STEP 2: 列出需要修改的文件
   - 完成此任务必须修改哪些文件？
   - 只列出必须修改的文件（最多5个）
   - 不要列出"可能"需要修改的文件

✅ STEP 3: 询问用户确认
   - "我计划修改以下X个文件：[列表]"
   - "是否理解正确？"
   - 等待用户确认后再继续
```

#### 第2步：调用修改防护系统
**在修改任何代码之前，必须先调用**：

```javascript
const { getInstance } = require('./ModificationProtectionSystem');
const protection = getInstance();

protection.validateScope(
    {
        description: '任务描述',
        targetFiles: ['file1.js', 'file2.js']
    },
    ['file1.js', 'file2.js']
);
```

**⚠️ 如果忘记调用，所有修改都会被阻止！**

#### 第3步：严格遵守修改范围
**只修改已声明的文件，绝对不要"顺便"修改其他内容！**

❌ **禁止的行为**：
- 修改其他函数/方法（即使在同一文件）
- 批量修改多个规则/记录（除非明确要求）
- "顺便优化"其他代码
- "发现问题顺便修复"
- "看起来这里也有问题，一起改了"

✅ **正确的行为**：
- 只修改当前任务直接相关的代码
- 保持其他代码完全不变
- 发现其他问题时，先报告，等待授权

#### 第4步：发现其他问题时的正确流程

```
发现其他问题
  ↓
【错误】直接修改 ❌
  ↓
【正确】按以下流程：
  1. 先完成当前任务
  2. 调用 protection.generateReport()
  3. 调用 protection.reset()
  4. 向用户报告发现的其他问题
  5. 询问："是否需要修复XXX？"
  6. 等待用户确认
  7. 获得授权后，开始新任务
  8. 重新执行第1-3步
```

#### 第5步：任务完成后生成报告

```javascript
// 生成修改报告
const report = protection.generateReport();

// 保存报告
protection.saveReport();

// 重置（准备下一个任务）
protection.reset();
```

### 🚨 MCP系统故障时的应急规则

**如果MCP修改防护系统不可用（服务器崩溃/拦截器失效）：**

⚠️ **加倍谨慎！必须手动执行以下检查**：

```
1. 在修改前，向用户明确报告：
   "⚠️ 检测到MCP防护系统不可用"
   "我将手动执行三重检查，请您审查"

2. 列出修改计划：
   - 任务描述
   - 要修改的文件（必须≤3个）
   - 每个文件的修改理由

3. 逐文件询问确认：
   "是否允许修改 file1.js？（用于修复XXX）"
   等待用户回复"允许"后再继续

4. 修改完成后，再次报告：
   "已完成修改：[文件列表]"
   "是否发现任何意外变更？"
```

### 📊 修改数量限制

| 文件数量 | 要求 |
|---------|------|
| 1个文件 | 直接修改 |
| 2-3个文件 | 列出修改理由，询问确认 |
| 4-5个文件 | 详细说明每个文件的修改原因，等待确认 |
| >5个文件 | ❌ 拒绝！要求拆分为多个任务 |

### ⚖️ 违规后果

**如果违反此规则（越界修改）**：

1. 🛑 立即停止所有修改
2. 📋 生成违规报告
3. 🔄 回滚所有越界修改
4. 📢 向用户道歉并说明情况
5. 🔒 记录到违规历史
6. 🚫 重新开始任务（正确流程）

### 🎯 判断标准

**如何判断是否"越界"？**

✅ **允许修改**：
- 用户明确指定的文件
- 当前功能模块直接相关的代码
- 修改不影响其他功能

❌ **越界修改**：
- 其他功能模块的代码
- "看起来也有问题"的代码
- "可以顺便优化"的代码
- 不在声明范围内的任何文件

### 📚 历史教训

**案例1**: upgrade-all-rules-to-block.js事件
- 任务：修复一个规则
- 实际：批量修改了所有规则
- 后果：系统完全失效
- 教训：绝对不要"批量修改"

**案例2**: 修复统计功能破坏团队模式
- 任务：修复统计累加问题
- 实际：顺便优化了团队模式代码
- 后果：团队模式出现新Bug
- 教训：不要"顺便优化"

**案例3**: 优化锁管理器导致响应拦截器失效
- 任务：优化锁管理器性能
- 实际：修改了共享的工具函数
- 后果：响应拦截器依赖的函数被破坏
- 教训：考虑影响范围

---

**总结**：收到任务 → 暂停 → 复述 → 列出文件 → 确认 → validateScope() → 修改 → 报告 → reset()

## 规则8: 禁止降级修复 (v7.8.7新增)
- ✅ 找到根本原因，直接修复
- 🚫 严禁用低级方案替代高级方案

## 规则9: 强制归档系统 (v7.10.8新增)
- ✅ 每次对话结束后自动存档
- ✅ Bug修复必须记录

---

## 规则10: 三重保护体系 (v7.11.2新增)

### 🛡️ 保护层级

```
第一重：.cursorrules规则约束（本规则）
  ↓ 失效时
第二重：MCP修改防护拦截器（技术强制）
  ↓ 失效时
第三重：用户手动确认（最后防线）
```

### 📋 AI自检清单（每次修改前必读）

**在修改任何代码之前，必须回答以下问题：**

```
□ 我是否已经复述了用户需求？
□ 我是否列出了要修改的文件（≤5个）？
□ 我是否得到了用户确认？
□ 我是否调用了 protection.validateScope()？
□ 我是否只修改任务直接相关的代码？
□ 我是否发现了其他问题但没有"顺便"修改？
□ 我是否准备在完成后生成报告？

如果有任何一项是 ❌，立即暂停！
```

### 🚨 故障模式应对

| 故障类型 | 检测方法 | 应对措施 |
|---------|---------|---------|
| MCP服务器崩溃 | 工具调用失败 | 启用应急规则（规则7-MCP故障部分） |
| 拦截器失效 | 无拦截日志 | 手动执行三重检查 + 人工确认 |
| 防护系统禁用 | `setEnabled(false)` | 拒绝修改，要求重新启用 |
| 规则文件损坏 | 无法读取.cursorrules | 停止所有修改，报告用户 |

### 💡 最佳实践

**永远遵循的原则**：
1. 🎯 一次只解决一个问题
2. 📝 修改前必须声明范围
3. 🚫 发现其他问题时绝不"顺便"修改
4. ✅ 完成任务后必须生成报告
5. 🔄 开始新任务前必须reset()

---

**版本**: v7.11.2-三重保护强化版  
**最后更新**: 2025-10-31  
**重大更新**: 规则7扩展为完整操作流程 + 新增规则10三重保护体系
