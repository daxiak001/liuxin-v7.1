# 🏗️【架构设计】- 用户管理功能

**项目名称**: 用户管理功能  
**创建时间**: 2025-10-31  
**维护者**: 开发工程师-小柳

---

## 📋 架构总览

### 整体架构模式
**三层架构 + 中间件模式**

```
┌─────────────────────────────────────┐
│         API路由层（Routes）          │
│   - 定义API端点                     │
│   - 参数验证                        │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│      中间件层（Middlewares）         │
│   - JWT验证中间件                   │
│   - 权限验证中间件                  │
│   - 错误处理中间件                  │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│      业务逻辑层（Services）          │
│   - AuthService（认证服务）         │
│   - UserService（用户管理服务）     │
│   - PermissionService（权限服务）   │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│      数据访问层（Models）            │
│   - UserModel（用户数据模型）       │
│   - RoleModel（角色数据模型）       │
│   - PermissionModel（权限数据模型） │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│         数据库层（SQLite）           │
│   - users表                         │
│   - roles表                         │
│   - permissions表                   │
│   - 关联表                          │
└─────────────────────────────────────┘
```

---

## 🎯 技术栈选型

### 核心技术

| 技术               | 版本   | 用途       | 选择理由              |
| ------------------ | ------ | ---------- | --------------------- |
| **Node.js**        | v18+   | 运行时环境 | 与柳芯系统一致        |
| **better-sqlite3** | latest | 数据库     | 轻量、高性能、同步API |
| **jsonwebtoken**   | latest | JWT认证    | 业界标准              |
| **bcrypt**         | latest | 密码加密   | 安全可靠              |
| **express** (可选) | latest | Web框架    | 简单易用              |

---

## 🔐 安全设计

### 1. 密码安全

**设计决策**：使用bcrypt进行密码加密

**为什么选择bcrypt？**
- ✅ 自动加盐（防止彩虹表攻击）
- ✅ 可配置工作因子（计算成本）
- ✅ 业界标准，经过时间验证
- ✅ 慢速算法（防止暴力破解）

**配置**：
```javascript
const bcrypt = require('bcrypt');
const SALT_ROUNDS = 12;  // 推荐值：10-12

// 密码加密
const passwordHash = await bcrypt.hash(password, SALT_ROUNDS);

// 密码验证
const isValid = await bcrypt.compare(password, passwordHash);
```

**教训**：
- ❌ 不要使用MD5/SHA1（已被破解）
- ❌ 不要自己实现加密算法
- ✅ 工作因子设置为12（平衡安全性和性能）

---

### 2. JWT认证

**设计决策**：使用JWT Token进行无状态认证

**为什么选择JWT？**
- ✅ 无状态（不需要服务器存储session）
- ✅ 可扩展（易于水平扩展）
- ✅ 跨域友好
- ✅ 移动端友好

**Token结构**：
```javascript
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "userId": 1,
    "username": "user123",
    "roles": ["user"],
    "iat": 1698765432,
    "exp": 1698851832
  },
  "signature": "..."
}
```

**安全配置**：
```javascript
const jwt = require('jsonwebtoken');

// 密钥管理（⚠️ 生产环境必须使用环境变量）
const JWT_SECRET = process.env.JWT_SECRET || 'dev-secret-key';
const JWT_EXPIRES_IN = '24h';  // Token过期时间

// 生成Token
const token = jwt.sign(
  { userId, username, roles },
  JWT_SECRET,
  { expiresIn: JWT_EXPIRES_IN }
);

// 验证Token
const decoded = jwt.verify(token, JWT_SECRET);
```

**教训**：
- ❌ 不要在Token中存储敏感信息（密码、支付信息等）
- ❌ 不要使用弱密钥（至少32字节随机字符串）
- ✅ 设置合理的过期时间（建议24小时）
- ✅ 生产环境必须从环境变量读取密钥

---

### 3. 权限验证

**设计决策**：基于角色的访问控制（RBAC）

**为什么选择RBAC？**
- ✅ 灵活性高（角色可自由组合权限）
- ✅ 易于维护（修改角色权限即可，无需修改用户）
- ✅ 符合企业实际需求
- ✅ 可扩展性强

**权限验证流程**：
```
1. 用户登录 → 生成JWT Token（包含用户角色）
2. 请求API → 携带Token
3. JWT中间件验证 → 提取用户ID和角色
4. 权限中间件验证 → 检查角色是否有权限
5. 通过验证 → 执行业务逻辑
6. 验证失败 → 返回403 Forbidden
```

**中间件实现**：
```javascript
// JWT验证中间件
function authenticateToken(req, res, next) {
  const token = req.headers['authorization']?.split(' ')[1];
  if (!token) return res.status(401).json({ error: 'No token provided' });
  
  jwt.verify(token, JWT_SECRET, (err, decoded) => {
    if (err) return res.status(403).json({ error: 'Invalid token' });
    req.user = decoded;
    next();
  });
}

// 权限验证中间件
function requirePermission(permission) {
  return (req, res, next) => {
    const userPermissions = getUserPermissions(req.user.roles);
    if (!userPermissions.includes(permission)) {
      return res.status(403).json({ error: 'Permission denied' });
    }
    next();
  };
}
```

---

## 📊 数据库设计原则

### 1. 表结构设计

**设计原则**：
- ✅ 第三范式（3NF）- 减少数据冗余
- ✅ 合理使用外键（保证数据完整性）
- ✅ 添加索引（优化查询性能）
- ✅ 软删除（status字段，不直接删除数据）

**索引策略**：
```sql
-- 用户表索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);

-- 用户-角色关联表索引
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);
```

**为什么这样设计索引？**
- ✅ username/email是高频查询字段（登录、注册）
- ✅ status用于过滤活跃用户
- ✅ 外键字段添加索引（加速JOIN查询）

---

### 2. 数据迁移策略

**设计决策**：版本化迁移脚本

**目录结构**：
```
migrations/
  ├── 001_create_users_table.sql
  ├── 002_create_roles_table.sql
  ├── 003_create_permissions_table.sql
  ├── 004_create_user_roles_table.sql
  └── 005_create_role_permissions_table.sql
```

**为什么这样设计？**
- ✅ 版本号递增（易于管理）
- ✅ 每个迁移独立（易于回滚）
- ✅ SQL文件可读性高（易于审查）

---

## 🔄 API设计原则

### RESTful API设计

**资源命名规范**：
```
GET    /api/users          - 获取用户列表
GET    /api/users/:id      - 获取单个用户
POST   /api/users          - 创建用户
PUT    /api/users/:id      - 更新用户
DELETE /api/users/:id      - 删除用户

POST   /api/auth/register  - 用户注册
POST   /api/auth/login     - 用户登录
POST   /api/auth/logout    - 用户登出
```

**响应格式统一**：
```javascript
// 成功响应
{
  "success": true,
  "data": { ... },
  "message": "操作成功"
}

// 错误响应
{
  "success": false,
  "error": {
    "code": "AUTH_001",
    "message": "用户名或密码错误"
  }
}
```

---

## 🚀 性能优化策略

### 1. 数据库查询优化

**策略**：
- ✅ 使用预编译语句（防止SQL注入 + 性能提升）
- ✅ 批量查询（减少数据库往返次数）
- ✅ 合理使用索引
- ✅ 避免N+1查询问题

**示例**：
```javascript
// ❌ 错误：N+1查询
const users = db.prepare('SELECT * FROM users').all();
users.forEach(user => {
  const roles = db.prepare('SELECT * FROM user_roles WHERE user_id = ?').all(user.id);
  user.roles = roles;
});

// ✅ 正确：JOIN查询
const usersWithRoles = db.prepare(`
  SELECT u.*, r.name as role_name
  FROM users u
  LEFT JOIN user_roles ur ON u.id = ur.user_id
  LEFT JOIN roles r ON ur.role_id = r.id
`).all();
```

---

### 2. 缓存策略（未来优化）

**可选缓存方案**：
- 用户信息缓存（减少数据库查询）
- 权限信息缓存（加速权限验证）
- Token黑名单缓存（实现登出功能）

**注意**：第一版不实现缓存，等性能瓶颈出现再优化。

---

## 📝 错误处理策略

### 统一错误码

| 错误码     | 含义             | HTTP状态码 |
| ---------- | ---------------- | ---------- |
| AUTH_001   | 用户名或密码错误 | 401        |
| AUTH_002   | Token无效或过期  | 403        |
| AUTH_003   | 权限不足         | 403        |
| USER_001   | 用户已存在       | 409        |
| USER_002   | 用户不存在       | 404        |
| VALID_001  | 参数验证失败     | 400        |
| SYSTEM_001 | 服务器内部错误   | 500        |

---

## 🧪 测试策略

### 测试层次

1. **单元测试**（覆盖率目标：80%+）
   - 测试Service层业务逻辑
   - 测试Model层数据访问
   - 测试中间件功能

2. **集成测试**
   - 测试API端到端流程
   - 测试数据库操作
   - 测试权限验证流程

3. **安全测试**
   - SQL注入测试
   - XSS攻击测试
   - 密码强度测试
   - Token安全测试

---

## 🔄 后续扩展方向

### 可能的功能扩展

1. **OAuth2.0集成**
   - 支持第三方登录（GitHub、Google等）

2. **多因素认证（MFA）**
   - 短信验证码
   - 邮箱验证码
   - TOTP（Google Authenticator）

3. **用户行为审计**
   - 登录日志
   - 操作日志
   - 敏感操作记录

4. **用户分组功能**
   - 部门管理
   - 团队管理
   - 组织架构

---

**最后更新**: 2025-10-31  
**维护者**: 开发工程师-小柳

