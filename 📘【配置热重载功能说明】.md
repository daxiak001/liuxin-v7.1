# 🔥 柳芯系统 - 配置热重载功能说明

**版本**: v7.11.1  
**更新时间**: 2025-10-31  
**文档类型**: 功能说明文档

---

## 📋 目录

1. [功能概述](#功能概述)
2. [支持的热重载范围](#支持的热重载范围)
3. [不支持热重载的内容](#不支持热重载的内容)
4. [技术实现](#技术实现)
5. [使用方法](#使用方法)
6. [常见问题](#常见问题)

---

## 功能概述

**配置热重载**是指在不重启 Cursor 的情况下，自动重新加载配置文件的变更。

### ✅ 已实现的功能

- **锁定配置热重载**: 修改 `lock-config.json` 后自动生效
- **数据库规则缓存清除**: 修改 `liuxin.db` 后自动清除规则引擎的 L1 缓存
- **统一管理**: 通过 `ConfigHotReloadManager` 统一管理所有配置热重载

### ❌ 不支持的功能

- **代码文件热重载**: 修改 `.js` 文件后必须重启 Cursor
- **原因**: Cursor MCP 以 stdio 模式运行，进程生命周期由 Cursor 控制

---

## 支持的热重载范围

### 1. 锁定配置 (`lock-config.json`)

**文件路径**: `locks/lock-config.json`

**修改后效果**:
- ✅ 自动重新加载配置（300ms 防抖）
- ✅ 显示配置变更摘要
- ✅ 立即生效，无需重启

**示例**:
```json
{
  "modules": {
    "statistics": {
      "locked": true  // 修改这个值会自动生效
    }
  }
}
```

**日志输出**:
```
🔄 [ConfigHotReload] 检测到配置变更: [lock-config] lock-config.json
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 [ConfigHotReload] 重新加载配置: [lock-config]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ [ConfigHotReload] 配置已更新: [lock-config]
   配置已更新！变更: 解锁1个
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### 2. 数据库规则 (`liuxin.db`)

**文件路径**: `liuxin.db`

**修改后效果**:
- ✅ 自动清除规则引擎的 L1 缓存
- ✅ 下次工具调用时从数据库重新加载规则
- ✅ 立即生效，无需重启

**适用场景**:
- 通过 SQL 工具修改数据库中的规则
- 修改规则的 `enabled` 字段
- 修改规则的 `action` 字段（warn/block）
- 添加/删除规则

**日志输出**:
```
🔄 [ConfigHotReload] 检测到配置变更: [db-rules] liuxin.db
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 [ConfigHotReload] 重新加载配置: [db-rules]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ [ConfigHotReload] 配置已更新: [db-rules]
   规则引擎缓存已清除: L1缓存已清除 (35条缓存)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 不支持热重载的内容

### ❌ 代码文件 (`.js` 文件)

**以下文件修改后必须重启 Cursor**:

| 文件名                         | 说明             | 原因                           |
| ------------------------------ | ---------------- | ------------------------------ |
| `liuxin-mcp-server-unified.js` | MCP 服务器主文件 | 进程启动时已初始化             |
| `ResponseInterceptor.js`       | 响应拦截器       | 已注册的类实例无法重新初始化   |
| `mcp-tool-wrappers.js`         | 工具包装器       | 已注册的工具 handlers 无法替换 |
| `LockManager.js`               | 锁管理器代码     | 已初始化的单例无法重新创建     |
| `v7.3-core-logic.js`           | 核心逻辑         | SmartPreloader 已加载          |
| 其他所有 `.js` 文件            | 任何代码文件     | Node.js 模块缓存限制           |

### 🚫 为什么代码文件不能热重载？

**Cursor MCP 的运行机制**:

```
┌─────────────────────────────────────────────┐
│               Cursor IDE                     │
│                                             │
│  1. 启动时 fork 一个 Node.js 进程           │
│     node liuxin-mcp-server-unified.js      │
│                                             │
│  2. 通过 stdio 与 MCP 服务器通信            │
│     stdin  ──→ MCP Server                  │
│     stdout ←── MCP Server                  │
│                                             │
│  3. 这个进程会一直运行，直到 Cursor 关闭    │
│                                             │
└─────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────┐
│       Node.js 进程（MCP Server）            │
│                                             │
│  启动时执行：                               │
│  ✓ 加载所有模块到内存                       │
│  ✓ 初始化全局变量                           │
│  ✓ 注册工具 handlers                       │
│  ✓ 启动 MCP Server                         │
│                                             │
│  ❌ 无法重新初始化（除非重启进程）          │
│                                             │
└─────────────────────────────────────────────┘
```

**关键限制**:
1. **模块缓存**: 清除 `require.cache` 只影响下次 `require()`
2. **全局状态**: 已初始化的全局变量、事件监听器无法重置
3. **进程控制**: MCP Server 无法自己重启自己，只有 Cursor 能重启

---

## 技术实现

### 核心组件

#### 1. `ConfigHotReloadManager.js`

**职责**:
- 统一管理所有配置文件的热重载
- 提供注册、取消注册、手动触发等接口
- 使用 `fs.watch()` 监听文件变更
- 带防抖功能（300ms）

**关键方法**:
```javascript
// 注册配置热重载
manager.register(
    'config-type',      // 配置类型标识
    '/path/to/config',  // 配置文件路径
    () => {             // 重载回调函数
        // 重新加载配置的逻辑
        return { success: true, message: '配置已更新' };
    }
);

// 取消注册
manager.unregister('/path/to/config');

// 停止所有监听
manager.stopAll();

// 手动触发重载
manager.manualReload('config-type');

// 显示监听状态
manager.showStatus();
```

#### 2. `LockManager.js` 集成

**v7.11.1 更新**:
- 移除内部的 `fs.watch()` 实现
- 使用 `ConfigHotReloadManager` 统一管理
- `startHotReload()` 方法已迁移
- `stopHotReload()` 方法保留以兼容

**代码示例**:
```javascript
// LockManager.startHotReload()
const { getInstance } = require('../ConfigHotReloadManager');
const hotReloadManager = getInstance();

hotReloadManager.register(
    'lock-config',
    this.configPath,
    () => this.reloadConfig()
);
```

#### 3. `liuxin-mcp-server-unified.js` 集成

**v7.11.1 新增**:
- 在 `main()` 函数中注册数据库规则热重载
- 监听 `liuxin.db` 文件变更
- 自动清除规则引擎的 L1 缓存

**代码示例**:
```javascript
ConfigHotReloadManager.register(
    'db-rules',
    dbPath,
    () => {
        if (server.interceptor && server.interceptor.clearCache) {
            const result = server.interceptor.clearCache();
            return {
                success: true,
                message: `规则引擎缓存已清除: ${result.message}`
            };
        }
        return { success: false, message: '规则引擎不可用' };
    }
);
```

---

## 使用方法

### 方法1: 修改配置文件（自动触发）

1. **修改 `lock-config.json`**:
```bash
# 使用任何编辑器修改配置
notepad locks/lock-config.json

# 或使用 VSCode
code locks/lock-config.json
```

2. **保存文件**
3. **等待 300ms**（防抖）
4. **配置自动生效** ✅

### 方法2: 修改数据库规则（自动触发）

1. **使用 SQL 工具修改数据库**:
```bash
sqlite3 liuxin.db

# 例如：禁用某条规则
UPDATE ai_rules SET enabled = 0 WHERE rule_code = 'RULE-001';

# 退出
.exit
```

2. **数据库文件被修改**
3. **等待 300ms**（防抖）
4. **规则引擎缓存自动清除** ✅
5. **下次工具调用时重新加载规则** ✅

### 方法3: 手动触发重载

```javascript
// 在 Node.js 环境中
const { getInstance } = require('./ConfigHotReloadManager');
const manager = getInstance();

// 手动触发重载
manager.manualReload('lock-config');
manager.manualReload('db-rules');
```

### 方法4: 查看监听状态

```javascript
const { getInstance } = require('./ConfigHotReloadManager');
const manager = getInstance();

// 显示所有监听状态
manager.showStatus();
```

---

## 常见问题

### Q1: 修改配置后没有自动生效？

**可能原因**:
1. **未启动 MCP 服务器**: 配置热重载只在 MCP 服务器运行时有效
2. **文件路径错误**: 确认修改的是正确的配置文件
3. **防抖延迟**: 等待 300ms 后再检查

**解决方法**:
```bash
# 检查 MCP 服务器是否运行
tasklist | findstr node

# 查看日志确认热重载是否触发
tail -f 柳芯v7.1完整系统-云端架构/mcp-server-debug.log
```

### Q2: 修改代码文件后没有生效？

**这是正常的！** 代码文件不支持热重载。

**解决方法**:
1. **重启 Cursor** - 这是唯一的方法
2. 或者切换到 SSE 模式（需要独立 HTTP 服务器）

### Q3: 如何添加新的配置热重载？

**步骤**:
1. 确认配置是 JSON 或数据库文件（不是代码文件）
2. 在 `main()` 函数中注册:

```javascript
ConfigHotReloadManager.register(
    'my-config',
    '/path/to/my-config.json',
    () => {
        // 重新加载配置的逻辑
        // ...
        return { success: true, message: '配置已更新' };
    }
);
```

### Q4: HotReloadManager.js 还在使用吗？

**不再使用！** `HotReloadManager.js` 已在 v7.11.1 废弃。

**原因**:
- 试图实现代码热重载，但技术上不可行
- 清除模块缓存无法让已初始化的代码重新执行

**替代方案**:
- 使用 `ConfigHotReloadManager.js` 进行配置热重载
- 代码修改后重启 Cursor

### Q5: 如何测试热重载功能？

**使用测试脚本**:
```bash
cd 柳芯v7.1完整系统-云端架构
node test-config-hot-reload.js
```

**测试脚本会**:
- 加载 ConfigHotReloadManager
- 验证 LockManager 集成
- 显示当前监听状态
- 运行 30 秒以测试热重载

---

## 📊 热重载覆盖范围总结

| 配置类型       | 文件路径                 | 是否支持 | 生效方式         |
| -------------- | ------------------------ | -------- | ---------------- |
| **锁定配置**   | `locks/lock-config.json` | ✅        | 自动重新加载配置 |
| **数据库规则** | `liuxin.db`              | ✅        | 清除 L1 缓存     |
| **代码文件**   | `*.js`                   | ❌        | 必须重启 Cursor  |

---

## 🔗 相关文档

- [📘 柳芯系统完整文档](./📘【柳芯系统完整文档】.json)
- [🔒 锁管理器说明](./locks/README.md)
- [📋 系统架构说明](./README.md)

---

## 📝 更新历史

| 版本    | 日期       | 更新内容                        |
| ------- | ---------- | ------------------------------- |
| v7.11.1 | 2025-10-31 | 创建统一配置热重载管理器        |
| v7.10.5 | 2025-10-29 | 实现 LockManager 配置热重载     |
| v7.11.0 | 2025-10-31 | 创建 HotReloadManager（已废弃） |

---

**维护者**: 柳芯系统开发团队  
**最后更新**: 2025-10-31


