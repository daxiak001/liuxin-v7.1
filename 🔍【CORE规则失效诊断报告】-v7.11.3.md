# 🔍 CORE规则失效诊断报告

**版本**: v7.11.3  
**创建时间**: 2025-10-31  
**问题**: CORE-004和CORE-006规则未能有效触发

---

## 🚨 核心问题

**用户反馈**：
> "为什么没有触发.cursorrules中的规则要求，要先创建项目需要的文件然后再开始执行？这个找任何修复bug开发，迭代的时候都需要先按照这个规则聊制定计划否则很容易在工作的过程中出现很多不可控的风险导致无法继续工作。这条规则一直没有触发。"

**实际情况**：
- AI在收到"开始实施"请求后，直接开始工具调用
- 没有先读取项目5文件体系（🎯【项目总览】.json等）
- 没有按照CORE-004规定的流程执行
- CORE-006的"需求复述"有执行，但缺少"读取项目文档"这一前置步骤

---

## 📊 现有规则分析

### CORE-004（项目归档与记忆系统）

#### 当前规则内容（在.cursorrules中）

**位置**: `.cursorrules` JSON格式，第72-147行

**规则内容**：
```json
{
  "id": "CORE-004",
  "priority": 1,
  "name": "强制项目归档与记忆系统",
  "type": "CRITICAL_MUST",
  "rule": "每次任务/对话/开发/修复后，自动维护项目5文件体系 + 对话存档 + 经验记录",
  "核心目标": "读取1个核心索引文件→了解项目全貌→避免重复试错",
  "AI工作流程": {
    "新项目": "检查5文件→不存在则调用liuxin_project_file_generator生成",
    "任务前": "必读file1了解全貌",  // ⚠️ 关键：这里说要读，但没有强制
    "遇问题": "先查file5（经验库）看是否已有解决方案",
    "任务完成": "更新file1+file3（进度）",
    "新增功能": "更新file2（模块）",
    "修复Bug": "更新file5（经验库，必须记录失败方案）",
    "对话结束": "生成对话存档"
  }
}
```

#### ❌ 存在的问题

| 问题                   | 严重程度 | 说明                                                                                           |
| ---------------------- | -------- | ---------------------------------------------------------------------------------------------- |
| **不在Markdown规则中** | 🔴 严重   | AI主要读取的是`.cursorrules`文件（Markdown格式），而CORE-004在JSON格式的根目录`.cursorrules`中 |
| **"任务前"描述太弱**   | 🔴 严重   | 只说"必读file1"，但没有说"第一件事"、"在任何工具调用之前"                                      |
| **缺少强制执行流程**   | 🔴 严重   | 没有类似CORE-006那样的"第1步、第2步、第3步"强制流程                                            |
| **没有检测机制**       | 🟠 中等   | 没有自检清单，AI不知道如何验证自己是否遵守了                                                   |
| **没有违规后果**       | 🟠 中等   | 没有说明如果不读会有什么后果                                                                   |

---

### CORE-006（需求复述与执行计划）

#### 当前规则内容（在.cursorrules中）

**位置**: `.cursorrules` JSON格式，第165-198行

**规则内容**：
```json
{
  "id": "CORE-006",
  "priority": 1,
  "name": "需求复述与执行计划（强制执行）",
  "type": "CRITICAL_MUST",
  "rule": "收到用户任务后，第一件事：必须先复述用户需求，再提出执行计划，最后询问确认",
  "strictMode": true,
  "mandatorySteps": [
    "第1步：立即暂停，不要先执行",
    "第2步：按序号复述用户的每一项具体要求",
    "第3步：提出详细的执行计划（步骤1、2、3...）",
    "第4步：询问'是否理解正确？'",
    "第5步：等待用户确认后，再开始执行"
  ]
}
```

#### ⚠️ 存在的问题

| 问题                       | 严重程度 | 说明                                               |
| -------------------------- | -------- | -------------------------------------------------- |
| **不在Markdown规则中**     | 🔴 严重   | 同样在JSON格式文件中，AI主要读Markdown版本         |
| **缺少"读取项目文档"步骤** | 🔴 严重   | mandatorySteps中没有"读取🎯【项目总览】.json"这一步 |
| **执行计划不够详细**       | 🟡 轻微   | 没有强制要求执行计划包含"更新哪些项目文档"         |

---

## 🔍 根本原因分析

### 原因1：规则文件分裂 🔴 严重

**现状**：
```
项目根目录/
├── .cursorrules (JSON格式，包含CORE-001到CORE-006)
└── 柳芯v7.1完整系统-云端架构/
    └── .cursorrules (Markdown格式，包含规则0-10，但没有CORE-004和CORE-006的详细流程)
```

**问题**：
- AI在工作目录`柳芯v7.1完整系统-云端架构/`时，读取的是Markdown版本的`.cursorrules`
- Markdown版本的规则7（越界修改）和规则10（三重保护）有详细流程
- 但**没有CORE-004的"任务前必读项目文档"强制流程**
- 虽然有CORE-006的影子（规则7的第1步有复述），但**没有"读取项目文档"这一步**

---

### 原因2：CORE-004的"任务前"描述不够强制 🔴 严重

**当前描述**：
```json
"任务前": "必读file1了解全貌"
```

**问题**：
- ❌ 没有说"第一件事"
- ❌ 没有说"在任何工具调用之前"
- ❌ 没有说"在复述需求之前"
- ❌ 没有强制流程（像CORE-006那样的第1步、第2步）

**为什么AI会跳过**：
```
AI思维过程：
1. 用户说"开始实施" → 是"确认"信号 → 属于CORE-006的exception
2. CORE-006说"用户回复：确认"时不需要复述 → 直接开始执行
3. CORE-004说"任务前必读file1" → 但AI认为"任务"已经在之前开始了，现在是"继续执行"
4. 结果：AI跳过了"读取项目文档"这一步
```

---

### 原因3：CORE-004和CORE-006之间缺少衔接 🟠 中等

**当前情况**：
- CORE-006定义了"收到任务后的流程"（复述→计划→确认）
- CORE-004定义了"任务前要读文档"
- 但**两者没有明确的先后顺序和集成关系**

**应该是**：
```
收到任务
  ↓
第1步：读取项目文档（CORE-004） ← 缺失！
  ↓
第2步：复述需求（CORE-006）
  ↓
第3步：制定执行计划（CORE-006，应包含"更新哪些项目文档"）
  ↓
第4步：询问确认（CORE-006）
  ↓
第5步：执行任务
  ↓
第6步：更新项目文档（CORE-004）
```

**实际AI执行的**：
```
收到任务
  ↓
第1步：复述需求（CORE-006） ← 跳过了读取项目文档
  ↓
第2步：制定执行计划
  ↓
第3步：询问确认
  ↓
用户回复"确认"
  ↓
直接执行 ← 没有读取项目文档，也没有在计划中包含"更新项目文档"
```

---

## 💡 优化方案

### 方案A：强化Markdown版.cursorrules（推荐） ⭐⭐⭐⭐⭐

**思路**：
- 在`柳芯v7.1完整系统-云端架构/.cursorrules`（Markdown版）中
- 将CORE-004和CORE-006整合为一个超级流程
- 类似规则7那样，写成详细的"第1步、第2步..."

**新规则结构**：
```markdown
## 规则11: 强制任务启动流程（整合CORE-004+CORE-006） v7.11.3

### 🎯 适用场景
收到用户任务时（修复bug/开发功能/迭代系统），必须执行以下流程

### 📋 强制执行流程（必须100%遵守）

#### 阶段1：读取项目上下文（CORE-004）⚠️ 第一优先级

**在任何其他操作之前，必须先读取项目文档！**

✅ STEP 1: 读取核心索引文件
```javascript
// 必须先执行这一步！
const overview = await mcp_read_file('🎯【项目总览】.json');
```

✅ STEP 2: 了解项目全貌
- 当前版本是什么？
- 有哪些核心模块？
- 最近完成了什么任务？
- 已知问题有哪些？

✅ STEP 3: 检查经验库
```javascript
const experience = await mcp_read_file('📚【开发经验库】.json');
// 查找是否有类似问题的解决方案
```

⚠️ 如果文件不存在：
- 这可能是新项目或项目文档缺失
- 立即询问用户："是否需要生成项目5文件体系？"

---

#### 阶段2：需求复述与计划制定（CORE-006）

✅ STEP 4: 复述用户需求
- 核心目标是什么？
- 具体要求有哪些？（逐条列出）

✅ STEP 5: 制定详细执行计划
- 技术步骤（步骤1、2、3...）
- **必须包含：要创建/修改哪些文件**
- **必须包含：完成后要更新哪些项目文档**

✅ STEP 6: 询问确认
"是否理解正确？如有偏差请指正。"

✅ STEP 7: 等待用户确认后再执行

---

#### 阶段3：执行任务

（按照规则7的流程执行）

---

#### 阶段4：归档与记录（CORE-004）

✅ STEP 8: 更新项目文档
- 更新🎯【项目总览】.json
- 更新📊【项目进度追踪】.json
- 如果是新功能 → 更新📦【功能模块清单】.json
- 如果修复Bug → 更新📚【开发经验库】.json（必须记录失败方案）

✅ STEP 9: 生成对话存档
（自动触发，无需手动）

---

### 🚫 违规检测

**如果发现自己跳过了阶段1**：
1. 立即停止当前操作
2. 向用户道歉："抱歉，我违反了CORE-004规则，应该先读取项目文档"
3. 重新执行阶段1
4. 重新制定执行计划

---

### ✅ 自检清单

**在开始执行任务之前，必须确认：**
```
□ 我已经读取了🎯【项目总览】.json
□ 我已经读取了📚【开发经验库】.json
□ 我已经复述了用户需求
□ 我的执行计划包含了"要更新哪些项目文档"
□ 我已经得到了用户确认

如果有任何一项是 ❌，立即返回对应步骤！
```

---

### 🎯 关键原则

**永远记住**：
1. 📖 **任务第一件事：读取项目文档**（不是复述需求，而是先读文档）
2. 📝 **执行计划必须包含：要更新哪些项目文档**
3. 🚫 **绝不跳过：即使用户说"继续"或"确认"，第一次收到新任务时必须读文档**

---

### 💡 判断"新任务"的标准

**新任务** = 需要读取项目文档：
- 用户提出新的修复请求
- 用户提出新的开发需求
- 用户提出新的迭代计划
- 任何需要"制定计划"的场景

**不是新任务** = 不需要重新读文档：
- 用户回复"确认"（在已经读取文档并制定计划后）
- 用户回复"继续"（在任务执行中途）
- 用户回复"好的"（表示同意当前计划）
```

---

### 方案B：在CORE-006中嵌入"读取项目文档"步骤 ⭐⭐⭐⭐

**思路**：
- 修改根目录的`.cursorrules` JSON中的CORE-006
- 在mandatorySteps中增加"第0步：读取项目文档"

**修改**：
```json
"mandatorySteps": [
  "第0步：读取项目上下文（读取🎯【项目总览】.json和📚【开发经验库】.json）", // 新增
  "第1步：立即暂停，不要先执行",
  "第2步：按序号复述用户的每一项具体要求",
  "第3步：提出详细的执行计划（步骤1、2、3...，必须包含要更新的项目文档）", // 修改
  "第4步：询问'是否理解正确？'",
  "第5步：等待用户确认后，再开始执行"
]
```

---

### 方案C：创建新的CORE-007规则（最强制） ⭐⭐⭐⭐⭐

**思路**：
- 创建一个全新的规则：CORE-007（强制任务启动流程）
- 优先级设为0（最高）
- 明确说明：这是所有任务的前置流程

---

## 🎯 推荐方案

**综合方案：A + C**

1. **在Markdown版.cursorrules中新增规则11**（方案A的内容）
   - AI主要读取Markdown版本，这是最直接有效的
   - 类似规则7的详细流程，AI容易理解和遵守

2. **同时在JSON版.cursorrules中新增CORE-007**（方案C）
   - 作为系统级规则记录
   - 与其他CORE规则保持一致性

3. **更新CORE-006**（方案B部分内容）
   - 在mandatorySteps中增加"第0步：读取项目上下文"
   - 确保两个版本的规则一致

---

## 📊 预期效果

实施后，AI的执行流程将变为：

```
收到用户任务："实施五层防护系统"
  ↓
【检测】这是一个新任务吗？ → 是
  ↓
【执行规则11-阶段1】
  ↓ STEP 1: 读取🎯【项目总览】.json
  ↓ STEP 2: 读取📚【开发经验库】.json
  ↓ STEP 3: 了解项目当前状态
  ↓
【执行规则11-阶段2】
  ↓ STEP 4: 复述用户需求
  ↓ STEP 5: 制定执行计划（包含"要创建/更新的项目文档"）
  ↓ STEP 6: 询问确认
  ↓
【等待用户回复】
  ↓
用户回复："确认"
  ↓
【执行规则11-阶段3】执行任务
  ↓
【执行规则11-阶段4】更新项目文档 + 生成存档
```

---

## ✅ 下一步行动

1. **立即实施**：创建规则11（在Markdown版.cursorrules）
2. **同步更新**：更新JSON版.cursorrules中的CORE-006和新增CORE-007
3. **测试验证**：模拟新任务，验证AI是否按流程执行
4. **文档更新**：更新📘【柳芯系统完整文档】.json

---

**维护者**: 柳芯系统开发团队  
**创建时间**: 2025-10-31  
**状态**: ✅ 诊断完成，等待实施决策

